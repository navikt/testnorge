name: App app-tilgang-analyse-service

on:
  push:
    paths:
      - apps/app-tilgang-analyse-service/**
      - .github/workflows/app.app-tilgang-analyse-service.yml
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Should deploy?'
        required: true
        default: 'true'

env:
  IMAGE: docker.pkg.github.com/${{ github.repository }}/app-tilgang-analyse-service:${{ github.sha }}
  BUILD_PATH: 'apps/app-tilgang-analyse-service/'

jobs:
  build:
    uses: navikt/testnorge/.github/workflows/common.build.yml@github-workflows-new
    with:
      buildPath: 'apps/app-tilgang-analyse-service/'
      image: ${{ env.IMAGE }}
  deploy-dev-gcp:
    name: Deploy til dev-gcp
    needs: build
    runs-on: ubuntu-latest
    if: ${{  github.ref == 'refs/heads/master' && github.actor != 'dependabot[bot]' }}
    steps:
      - uses: actions/checkout@v1
      - name: Deploy to dev-gcp
        timeout-minutes: 5
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DOLLY_DEPLOY_API_KEY }}
          CLUSTER: dev-gcp
          RESOURCE: ${{ env.BUILD_PATH }}/config.yml
  scan:
    uses: navikt/testnorge/.github/workflows/common.sonar.yml@github-workflows-new
    with:
      buildPath: 'apps/app-tilgang-analyse-service/'
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
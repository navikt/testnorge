on:
  workflow_dispatch:
    inputs:
      target:
        type: choice
        description: "Backend or frontend."
        options:
          - "backend"
          - "frontend"
      type:
        type: choice
        description: "App or proxy. Used to resolve the working directory together with name, as <type>/<name>."
        options:
          - "apps"
          - "proxies"
      name:
        type: string
        description: "The workflow name, e.g. dolly-backend. Used to resolve the working directory together with type, as <type>/<name>."
        required: true
      force-deploy:
        type: boolean
        description: "Deploy?"
        default: false
      force-deploy-test:
        type: boolean
        description: "Deploy to test? Make sure the effective working directory contains a config.test.yml!"
        default: false

jobs:

  backend:
    if: inputs.target == 'backend'
    uses: ./.github/workflows/common.workflow.backend.yml
    with:
      working-directory: "${{ inputs.type }}/${{ inputs.name }}"
      deploy-tag: ""
      force-deploy: ${{ inputs.force-deploy }}
      force-deploy-test: ${{ inputs.force-deploy-test }}
    secrets:
      NAIS_DOLLY_DEPLOY_API_KEY: ${{ secrets.NAIS_DOLLY_DEPLOY_API_KEY }}
      NAIS_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }}
      NAV_TOKEN: ${{ secrets.NAV_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  frontend:
    if: inputs.target == 'frontend'
    uses: ./.github/workflows/common.workflow.frontend.yml
    with:
      working-directory: "${{ inputs.type }}/${{ inputs.name }}"
      deploy-tag: ""
      force-deploy: ${{ inputs.force-deploy }}
      force-deploy-test: ${{ inputs.force-deploy-test }}
    secrets:
      NAIS_DOLLY_DEPLOY_API_KEY: ${{ secrets.NAIS_DOLLY_DEPLOY_API_KEY }}
      NAIS_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }}
      NAV_TOKEN: ${{ secrets.NAV_TOKEN }}
      READER_TOKEN: ${{ secrets.READER_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
on:
  workflow_call:
    inputs:
      cluster:
        type: string
        description: "The cluster to deploy to, e.g. dev-gcp."
        required: false
        default: "dev-gcp"
      working-directory:
        type: string
        description: "The working directory for the job, e.g. apps/dolly-frontend (without leading/trailing slash)."
        required: true
      image-suffix:
        type: string
        description: "The Docker image suffix used for this particular workflow, e.g. dolly-frontend. Defaults to the workflow name."
        required: false
        default: ${{ github.workflow }}
      deploy-tag:
        type: string
        description: "The commit message tag that will trigger a deployment on a commit to a non-master branch, e.g. #deploy-frontend. Make sure it is not a substring of other deploy tags."
        required: true
      deploy-tag-test:
        type: string
        description: "The commit message tag that will trigger a deployment to the test environment on a commit to a non-master branch, e.g. #deploy-test-frontend."
        required: false
      deploy-tag-idporten:
        type: string
        description: "The commit message tag that will trigger a deployment to the 'idporten' environment on a commit to a non-master branch, e.g. #deploy-idporten-frontend."
        required: false
      deploy-tag-unstable:
        type: string
        description: "The commit message tag that will trigger a deployment to the 'unstable' environment on a commit to a non-master branch, e.g. #deploy-unstable-frontend."
        required: false
      force-deploy-test:
        type: boolean
        description: "Used to force deployment to test. Make sure the working-directory contains a config.test.yml!"
        required: false
        default: false
      force-deploy:
        type: boolean
        description: "Used to force deployment."
        required: false
        default: false
    secrets:
      NAIS_DOLLY_DEPLOY_API_KEY:
        required: true
      NAIS_WORKLOAD_IDENTITY_PROVIDER:
        required: true
      NAV_TOKEN:
        required: true
      READER_TOKEN:
        required: true
      SONAR_TOKEN:
        required: true

env:
  do-deploy-unstable: ${{ inputs.deploy-tag-unstable != '' && ( github.ref == 'refs/heads/master' || contains(github.event.head_commit.message, inputs.deploy-tag-unstable) ) }}
  do-deploy-idporten: ${{ inputs.deploy-tag-idporten != '' && ( github.ref == 'refs/heads/master' || contains(github.event.head_commit.message, inputs.deploy-tag-idporten) ) }}
  do-deploy-test: ${{ inputs.force-deploy-test || ( inputs.deploy-tag-test != '' && ( github.ref == 'refs/heads/master' || contains(github.event.head_commit.message, inputs.deploy-tag-test) ) ) }}
  do-deploy: ${{ inputs.force-deploy || ( inputs.deploy-tag != '' && ( github.ref == 'refs/heads/master' || contains(github.event.head_commit.message, inputs.deploy-tag) ) ) }}

jobs:

  sonar:
    secrets:
      NAV_TOKEN: ${{ secrets.NAV_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    uses: ./.github/workflows/common.scan.sonar.yml
    with:
      working-directory: ${{ inputs.working-directory }}

  build:
    if: github.actor != 'dependabot[bot]'
    permissions:
      contents: "read"
      id-token: "write"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v3
      - name: "Setup (Node)"
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@navikt'
      - name: "Install (Node)"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}
        working-directory: ${{ inputs.working-directory }}/src/main/js
        run: npm ci
      - name: "Build (Node)"
        working-directory: ${{ inputs.working-directory }}/src/main/js
        run: npm run build
      - name: "Move (Node)"
        working-directory: ${{ inputs.working-directory }}/src/main/js
        run: mv build ../resources/static
      - name: "Java"
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17.x'
      - name: "Gradle"
        env:
          GITHUB_USERNAME: token
          NAV_TOKEN: ${{ secrets.NAV_TOKEN }}
        uses: gradle/gradle-build-action@v2
        with:
          build-root-directory: ${{ inputs.working-directory }}
          arguments: build --scan
          cache-read-only: false
      - name: "Docker"
        id: docker-build-push
        if: |
          env.do-deploy-unstable == 'true' ||
          env.do-deploy-idporten == 'true' ||
          env.do-deploy-test == 'true' ||
          env.do-deploy == 'true'
        uses: nais/docker-build-push@v0
        with:
          team: dolly
          identity_provider: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }}
          project_id: ${{ vars.NAIS_MANAGEMENT_PROJECT_ID }}
          dockerfile: ${{ inputs.working-directory }}/Dockerfile
          docker_context: ${{ inputs.working-directory }}
          image_suffix: ${{ inputs.image-suffix }}
    outputs:
      image: ${{ steps.docker-build-push.outputs.image }}
      do-deploy-unstable: ${{ env.do-deploy-unstable }}
      do-deploy-idporten: ${{ env.do-deploy-idporten }}
      do-deploy-test: ${{ env.do-deploy-test }}
      do-deploy: ${{ env.do-deploy }}

  # Only used by dolly-frontend.
  deploy-unstable:
    needs: build
    if: needs.build.outputs.do-deploy-unstable == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v3
      - name: "Deploy (unstable)"
        env:
          APIKEY: ${{ secrets.NAIS_DOLLY_DEPLOY_API_KEY }}
          CLUSTER: ${{ inputs.cluster }}
          RESOURCE: ${{ inputs.working-directory }}/config.unstable.yml
          VAR: image=${{ needs.build.outputs.image }}
        uses: nais/deploy/actions/deploy@v1

  # Only used by dolly-frontend.
  deploy-idporten:
    needs: build
    if: needs.build.outputs.do-deploy-idporten == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v3
      - name: "Deploy (idporten)"
        env:
          APIKEY: ${{ secrets.NAIS_DOLLY_DEPLOY_API_KEY }}
          CLUSTER: ${{ inputs.cluster }}
          RESOURCE: ${{ inputs.working-directory }}/config.idporten.yml
          VAR: image=${{ needs.build.outputs.image }}
        uses: nais/deploy/actions/deploy@v1

  deploy-test:
    needs: build
    if: needs.build.outputs.do-deploy-test == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v3
      - name: "Deploy (test)"
        env:
          APIKEY: ${{ secrets.NAIS_DOLLY_DEPLOY_API_KEY }}
          CLUSTER: ${{ inputs.cluster }}
          RESOURCE: ${{ inputs.working-directory }}/config.test.yml
          VAR: image=${{ needs.build.outputs.image }}
        uses: nais/deploy/actions/deploy@v1

  deploy:
    needs: build
    if: needs.build.outputs.do-deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v3
      - name: "Deploy"
        env:
          APIKEY: ${{ secrets.NAIS_DOLLY_DEPLOY_API_KEY }}
          CLUSTER: ${{ inputs.cluster }}
          RESOURCE: ${{ inputs.working-directory }}/config.yml
          VAR: image=${{ needs.build.outputs.image }}
        uses: nais/deploy/actions/deploy@v1
